# История изменений проекта

## 04.04.2025
### Расширение функционала секций "Выплаты" и "Трактор" для расходов
- Обновлены API эндпоинты `getExpenses`, `createExpense` и `updateExpense` для поддержки фильтрации по секциям
- Добавлено поле `section` в схемы валидации для расходов
- Добавлена визуальная индикация (бейджи) активной секции в заголовках доходов и расходов
- Реализована автоматическая установка секции при создании новых расходов
- Обновлены отчеты с учетом фильтрации по секциям
- Улучшено отображение интерфейса при переключении секций

## 04.04.2025
### Разделение функционала финансов на секции "Выплаты" и "Трактор"
- Добавлено поле `section` в модель `FinRow` для разделения записей по категориям PAYMENTS и TRACTOR
- Обновлен API роутер финансов для фильтрации данных по секциям
- Добавлены вкладки "Общее", "Выплаты" и "Трактор" на странице финансов
- Реализован выбор секции при создании и редактировании финансовой записи
- Обновлено боковое меню с отдельными ссылками на разделы финансов с параметрами URL
- Добавлена синхронизация URL с выбранной секцией для сохранения состояния между переходами
- Улучшен пользовательский интерфейс форм создания и редактирования финансовых записей

## 04.04.2025
### Разделение функционала зарплат на секции "Выплаты" и "Трактор"
- Реализовано разделение сотрудников, выплат, долгов и заработков по разделам PAYMENTS и TRACTOR
- Обновлен API роутер для фильтрации данных по секциям
- Добавлен переключатель разделов на странице зарплат
- Реализован выбор раздела при создании и редактировании сотрудника
- Обновлено боковое меню с отдельными ссылками для каждого раздела
- Добавлена фильтрация сотрудников по выбранному разделу
- Улучшен пользовательский интерфейс для разделения функционала зарплат

## 04.04.2025
### Реализация динамических полей для дней выплаты зарплаты
- Обновлена модель `Salary` в схеме Prisma: добавлены поля `payday2` и `payday3` для поддержки нескольких дней выплаты
- Реализовано динамическое отображение полей для дней выплаты в зависимости от выбранной периодичности оплаты
- Добавлена валидация дополнительных полей дней выплаты
- Обновлены API для работы с новыми полями
- Улучшены формы добавления и редактирования сотрудника для поддержки множественных дней выплаты
- Исправлена загрузка значений полей `payday2` и `payday3` в форму редактирования сотрудника из базы данных

### Улучшение функционала управления сотрудниками
- Исправлена ошибка удаления сотрудников при наличии связанных платежей
- Добавлен механизм каскадного удаления связанных записей для корректного удаления сотрудника из базы данных
- Добавлено новое поле `periodic` в модель `Salary` для указания типа периодичности оплаты
- Реализован выпадающий список выбора периодичности оплаты (раз в месяц, два раза в месяц, три раза в месяц)
- Исправлена ошибка валидации поля `comment`, теперь оно корректно обрабатывает null-значения
- Обновлена схема валидации в API-роутере для поддержки enum типов в форме редактирования сотрудника
- Улучшена форма редактирования сотрудника с учетом новых полей и связей

## 02.04.2025
### Полная переработка компонента просмотра таблицы
- Исправлена критическая ошибка "hooks[lastArg] is not a function" в компоненте отображения таблицы
- Полностью переписан компонент TableViewPage с использованием более надежной архитектуры
- Реализован последовательный подход к загрузке данных, устраняющий проблемы с асинхронностью
- Улучшена обработка CRUD-операций с использованием императивных функций вместо хуков
- Оптимизированы проверки обязательных полей и обработка ошибок
- Расширена валидация вводимых данных при добавлении и редактировании строк
- Упрощена структура компонента для лучшей поддерживаемости

### Исправление проблемы отображения таблиц в конструкторе таблиц
- Исправлена проблема с отображением сообщения "Таблица не найдена", когда API успешно возвращал данные таблицы
- Добавлен механизм двойного хранения данных таблицы (useState + useRef) для обхода проблем с асинхронными обновлениями состояния
- Улучшена обработка условий зависимостей для запросов и отображения данных
- Добавлено отладочное логирование для выявления проблем с состоянием React
- Оптимизированы проверки наличия данных с использованием оператора логического ИЛИ для повышения надёжности интерфейса

## 01.04.2025
### Исправление модуля управления сотрудниками
- Добавлена процедура `updateEmployee` в API-роутер для возможности редактирования сотрудников
- Реализовано диалоговое окно редактирования сотрудника, которое не открывалось ранее
- Добавлена кнопка удаления сотрудника в меню действий
- Реализована логика для корректной обработки редактирования и удаления сотрудников
- Исправлена проблема сохранения формы при редактировании данных
- Добавлена возможность редактирования комментария к информации о сотруднике
- Исправлена ошибка, из-за которой не работало редактирование данных при нажатии на кнопку "Редактировать сотрудника"

## 28.03.2025
- Исправлена ошибка уникального ограничения в `IdexTransaction` при синхронизации транзакций
- Улучшен механизм фильтрации существующих транзакций перед сохранением новых
- Добавлено логирование количества существующих транзакций для каждого кабинета
- Реализовано корректное сравнение составного ключа (externalId, cabinetId) для предотвращения дубликатов
- Добавлен механизм автоматических повторных попыток при временной недоступности базы данных Neon
- Реализована прогрессивная задержка между повторными попытками подключения к базе данных
- Улучшена обработка ошибок в процессе синхронизации транзакций из IDEX

## 27.03.2025
- Исправлена ошибка "Unsupported type <Item>" в компоненте UsersTable путем корректного использования структуры таблицы HeroUI
- Улучшена обработка данных пагинации в таблице пользователей
- Исправлена ошибка в AuthProvider, вызывающая циклические перенаправления между страницами
- Внедрен механизм предотвращения множественных перенаправлений с использованием состояния навигации
- Оптимизированы переходы между страницами с использованием router.replace вместо router.push

## 26.03.2025
- Обновлена история проекта для отражения последних изменений в связи с решением проблем типизации и авторизации
- Произведено подключение к базе данных Neon с использованием обновленной строки подключения
- Добавлены диагностические инструменты для проверки работы аутентификации
- Обнаружено несоответствие между вводимым кодом доступа и значением в базе данных

## 25.03.2025 
### Реализация функционала запросов на синхронизацию IDEX
- Добавлены новые API-методы в маршрутизатор idex.ts:
  - `createSyncAllCabinetsOrder` - создание запроса на синхронизацию всех кабинетов
  - `createSyncCabinetOrder` - создание запроса на синхронизацию конкретного кабинета
  - `getSyncHistory` - получение истории запросов на синхронизацию с пагинацией и фильтрацией
  - `getSyncOrderDetails` - получение детальной информации о конкретном запросе на синхронизацию
- Создан компонент `IdexSyncOrdersModal.tsx` для отображения запросов на синхронизацию
- Обновлена страница кабинетов IDEX:
  - Добавлена кнопка "История синхронизаций", открывающая модальное окно с запросами
  - Интегрирован компонент `IdexSyncOrdersModal` для просмотра запросов на синхронизацию
  - Реализовано автоматическое открытие модального окна с историей после создания запроса
- Изменен подход к синхронизации: вместо прямой обработки, создаются запросы (ордера) на синхронизацию
- Реализована система отображения статусов запросов с использованием цветных бейджей
- Добавлена возможность фильтрации запросов по статусу

## 24.03.2025
- Исправлена ошибка уникального ограничения в `IdexTransaction` при синхронизации транзакций
- Улучшен механизм фильтрации существующих транзакций перед сохранением новых
- Добавлено логирование количества существующих транзакций для каждого кабинета
- Реализовано корректное сравнение составного ключа (externalId, cabinetId) для предотвращения дубликатов
- Добавлен механизм автоматических повторных попыток при временной недоступности базы данных Neon
- Реализована прогрессивная задержка между повторными попытками подключения к базе данных
- Улучшена обработка ошибок в процессе синхронизации транзакций из IDEX

## 23.03.2025
- Удалены устаревшие зависимости от роутера post.ts
- Исправлены импорты компонентов Dropdown из HeroUI (@heroui/dropdown)
- Создан клиентский компонент Providers.tsx для обертки всех провайдеров
- Изменена архитектура приложения для работы с серверными/клиентскими компонентами Next.js
- Переработана главная страница для использования клиентских данных вместо серверных
- Создана индексная структура папок компонентов для лучшей поддержки типов
- Исправлена ошибка с использованием метаданных в клиентском компоненте (layout.tsx теперь серверный)

## 22.03.2025
- Добавлена утилита для объединения CSS классов (utils.ts)
- Создан компонент StatCard для отображения статистических данных на дашборде
- Создан компонент UsersTable для отображения и управления пользователями
- Исправлены импорты компонентов HeroUI для правильной работы библиотеки UI
- Обновлена структура проекта в документации

## 21.03.2025
### Фильтрация транзакций по кабинетам IDEX
- Добавлена поддержка параметра `cabinetIds` во все основные методы API для фильтрации транзакций
- Реализован метод `getCabinetMatchStats` для получения статистики по выбранным кабинетам
- Добавлена функция `calculateTotalStats` для расчета общей статистики сопоставлений
- Исправлена ошибка экспорта маршрутизатора `matchRouter`
- Обновлена логика фильтрации, чтобы корректно обрабатывать выбранные кабинеты во всех API-запросах

## 20.03.2025
- Обновление файла root.ts - добавление новых маршрутизаторов (auth, users, transactions)
- Исправление ошибок типизации в authStore.ts (корректировка типа adminData)
- Исправление ошибок типизации в users.ts (корректная работа с фильтрами Prisma)
- Исправление ошибок типизации в transactions.ts (проверки на undefined значения)
- Добавлен столбец "ID IDEX кабинета" в таблицы сопоставлений транзакций
- Обновлен запрос getAllMatches для включения информации о кабинете IDEX в ответе
- Расширен функционал экспорта в CSV для включения идентификатора кабинета IDEX
- Улучшено отображение данных на странице matches для упрощения идентификации транзакций

## 19.03.2025
- Реорганизация структуры макета с правильным позиционированием сайдбара
- Исправлено дублирование сайдбара в layout.tsx и page.tsx
- Внедрена гибкая flexbox-структура с сайдбаром слева и основным контентом справа
- Оптимизирован верхний уровень компонентов для соответствия лучшим практикам Next.js
